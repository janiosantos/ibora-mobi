STARTING TEST SCRIPT
Entering async function
--- Setting up Test Data ---
(trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/home/jpsantos/.pyenv/versions/3.11.9/lib/python3.11/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
2025-12-17 10:23:35,717 INFO sqlalchemy.engine.Engine select pg_catalog.version()
2025-12-17 10:23:35,717 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-12-17 10:23:35,720 INFO sqlalchemy.engine.Engine select current_schema()
2025-12-17 10:23:35,720 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-12-17 10:23:35,723 INFO sqlalchemy.engine.Engine show standard_conforming_strings
2025-12-17 10:23:35,723 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-12-17 10:23:35,724 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-17 10:23:35,729 INFO sqlalchemy.engine.Engine INSERT INTO users (id, email, phone, password_hash, user_type, email_verified, phone_verified, email_verified_at, phone_verified_at, status, mfa_enabled, mfa_secret, last_login_at) VALUES ($1::UUID, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::BOOLEAN, $7::BOOLEAN, $8::TIMESTAMP WITH TIME ZONE, $9::TIMESTAMP WITH TIME ZONE, $10::VARCHAR, $11::BOOLEAN, $12::VARCHAR, $13::TIMESTAMP WITH TIME ZONE) RETURNING users.created_at, users.updated_at
2025-12-17 10:23:35,729 INFO sqlalchemy.engine.Engine [generated in 0.00054s] (UUID('0e959989-52a6-4870-8484-843ac1398583'), 'driver_payout_0e54d5b3-4f7d-42cc-858b-918c750aecbd@example.com', None, '$2b$12$SbntZgf20k0LVe0gnkkR9efN5lFzJxVRtfsYmsOToLq5oZmIf0l66', 'driver', False, False, None, None, 'active', False, None, None)
2025-12-17 10:23:35,735 INFO sqlalchemy.engine.Engine COMMIT
2025-12-17 10:23:35,738 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-17 10:23:35,742 INFO sqlalchemy.engine.Engine SELECT users.id, users.email, users.phone, users.password_hash, users.user_type, users.email_verified, users.phone_verified, users.email_verified_at, users.phone_verified_at, users.status, users.mfa_enabled, users.mfa_secret, users.created_at, users.updated_at, users.last_login_at 
FROM users 
WHERE users.id = $1::UUID
2025-12-17 10:23:35,742 INFO sqlalchemy.engine.Engine [generated in 0.00028s] (UUID('0e959989-52a6-4870-8484-843ac1398583'),)
2025-12-17 10:23:35,751 INFO sqlalchemy.engine.Engine INSERT INTO drivers (id, user_id, full_name, cpf, phone, email, cnh_number, cnh_category, cnh_expiry_date, bank_code, bank_branch, bank_account, bank_account_type, pix_key, pix_key_type, status, approval_status, approved_at, approved_by, current_lat, current_lon, current_heading, last_location_update, average_rating, total_ratings, total_rides, total_distance_km, total_earnings, online, accepting_rides, last_ride_at) VALUES ($1::UUID, $2::UUID, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR, $7::VARCHAR, $8::VARCHAR, $9::DATE, $10::VARCHAR, $11::VARCHAR, $12::VARCHAR, $13::VARCHAR, $14::VARCHAR, $15::VARCHAR, $16::VARCHAR, $17::VARCHAR, $18::TIMESTAMP WITH TIME ZONE, $19::UUID, $20::NUMERIC(10, 8), $21::NUMERIC(11, 8), $22::NUMERIC(5, 2), $23::TIMESTAMP WITH TIME ZONE, $24::NUMERIC(3, 2), $25::INTEGER, $26::INTEGER, $27::NUMERIC(10, 2), $28::NUMERIC(10, 2), $29::BOOLEAN, $30::BOOLEAN, $31::TIMESTAMP WITH TIME ZONE) RETURNING drivers.created_at, drivers.updated_at
2025-12-17 10:23:35,751 INFO sqlalchemy.engine.Engine [generated in 0.00063s] (UUID('ebf3fe71-e606-4c9d-a760-a6c7affc40c6'), UUID('0e959989-52a6-4870-8484-843ac1398583'), 'Payout Tester', '91046048775', '+5511999999999', 'driver_payout_0e54d5b3-4f7d-42cc-858b-918c750aecbd@example.com', '22971380516768590933', 'B', datetime.date(2030, 1, 1), None, None, None, None, None, None, 'active', 'pending', None, None, None, None, None, None, 5.0, 0, 0, 0.0, 0.0, False, True, None)
2025-12-17 10:23:35,756 INFO sqlalchemy.engine.Engine COMMIT
2025-12-17 10:23:35,758 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-17 10:23:35,761 INFO sqlalchemy.engine.Engine SELECT drivers.id, drivers.user_id, drivers.full_name, drivers.cpf, drivers.phone, drivers.email, drivers.cnh_number, drivers.cnh_category, drivers.cnh_expiry_date, drivers.bank_code, drivers.bank_branch, drivers.bank_account, drivers.bank_account_type, drivers.pix_key, drivers.pix_key_type, drivers.status, drivers.approval_status, drivers.approved_at, drivers.approved_by, drivers.current_lat, drivers.current_lon, drivers.current_heading, drivers.last_location_update, drivers.average_rating, drivers.total_ratings, drivers.total_rides, drivers.total_distance_km, drivers.total_earnings, drivers.online, drivers.accepting_rides, drivers.created_at, drivers.updated_at, drivers.last_ride_at 
FROM drivers 
WHERE drivers.id = $1::UUID
2025-12-17 10:23:35,762 INFO sqlalchemy.engine.Engine [generated in 0.00029s] (UUID('ebf3fe71-e606-4c9d-a760-a6c7affc40c6'),)
Created Driver: ebf3fe71-e606-4c9d-a760-a6c7affc40c6
2025-12-17 10:23:35,769 INFO sqlalchemy.engine.Engine SELECT ledger_accounts.id, ledger_accounts.code, ledger_accounts.name, ledger_accounts.description, ledger_accounts.type, ledger_accounts.classification, ledger_accounts.user_id, ledger_accounts.entity_id, ledger_accounts.entity_type, ledger_accounts.balance, ledger_accounts.is_active, ledger_accounts.created_at, ledger_accounts.updated_at 
FROM ledger_accounts 
WHERE ledger_accounts.code = $1::VARCHAR
2025-12-17 10:23:35,769 INFO sqlalchemy.engine.Engine [generated in 0.00032s] ('2100-ebf3fe71',)
2025-12-17 10:23:35,777 INFO sqlalchemy.engine.Engine INSERT INTO ledger_accounts (id, code, name, description, type, classification, user_id, entity_id, entity_type, balance, is_active) VALUES ($1::UUID, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR, $7::UUID, $8::UUID, $9::VARCHAR, $10::NUMERIC(19, 4), $11::BOOLEAN) RETURNING ledger_accounts.created_at, ledger_accounts.updated_at
2025-12-17 10:23:35,777 INFO sqlalchemy.engine.Engine [generated in 0.00043s] (UUID('66d4f290-bc62-4871-8e70-a7ecb5e47afb'), '2100-ebf3fe71', 'Motorista - ebf3fe71-e606-4c9d-a760-a6c7affc40c6', None, 'LIABILITY', 'DETAIL', None, None, None, 0, True)
2025-12-17 10:23:35,779 INFO sqlalchemy.engine.Engine COMMIT
2025-12-17 10:23:35,781 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-17 10:23:35,783 INFO sqlalchemy.engine.Engine SELECT ledger_accounts.id, ledger_accounts.code, ledger_accounts.name, ledger_accounts.description, ledger_accounts.type, ledger_accounts.classification, ledger_accounts.user_id, ledger_accounts.entity_id, ledger_accounts.entity_type, ledger_accounts.balance, ledger_accounts.is_active, ledger_accounts.created_at, ledger_accounts.updated_at 
FROM ledger_accounts 
WHERE ledger_accounts.id = $1::UUID
2025-12-17 10:23:35,783 INFO sqlalchemy.engine.Engine [generated in 0.00022s] (UUID('66d4f290-bc62-4871-8e70-a7ecb5e47afb'),)
2025-12-17 10:23:35,786 INFO sqlalchemy.engine.Engine SELECT ledger_accounts.id, ledger_accounts.code, ledger_accounts.name, ledger_accounts.description, ledger_accounts.type, ledger_accounts.classification, ledger_accounts.user_id, ledger_accounts.entity_id, ledger_accounts.entity_type, ledger_accounts.balance, ledger_accounts.is_active, ledger_accounts.created_at, ledger_accounts.updated_at 
FROM ledger_accounts 
WHERE ledger_accounts.code = $1::VARCHAR
2025-12-17 10:23:35,786 INFO sqlalchemy.engine.Engine [cached since 0.01775s ago] ('3000',)
2025-12-17 10:23:35,788 INFO sqlalchemy.engine.Engine INSERT INTO ledger_accounts (id, code, name, description, type, classification, user_id, entity_id, entity_type, balance, is_active) VALUES ($1::UUID, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR, $7::UUID, $8::UUID, $9::VARCHAR, $10::NUMERIC(19, 4), $11::BOOLEAN) RETURNING ledger_accounts.created_at, ledger_accounts.updated_at
2025-12-17 10:23:35,789 INFO sqlalchemy.engine.Engine [cached since 0.01206s ago] (UUID('e0966039-9420-47ef-8f43-bdfdb2d432e6'), '3000', 'Despesa Servicos', None, 'EXPENSE', 'DETAIL', None, None, None, 0, True)
2025-12-17 10:23:35,790 INFO sqlalchemy.engine.Engine COMMIT
2025-12-17 10:23:35,792 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-17 10:23:35,793 INFO sqlalchemy.engine.Engine SELECT ledger_accounts.id, ledger_accounts.code, ledger_accounts.name, ledger_accounts.description, ledger_accounts.type, ledger_accounts.classification, ledger_accounts.user_id, ledger_accounts.entity_id, ledger_accounts.entity_type, ledger_accounts.balance, ledger_accounts.is_active, ledger_accounts.created_at, ledger_accounts.updated_at 
FROM ledger_accounts 
WHERE ledger_accounts.id = $1::UUID
2025-12-17 10:23:35,793 INFO sqlalchemy.engine.Engine [cached since 0.01036s ago] (UUID('e0966039-9420-47ef-8f43-bdfdb2d432e6'),)
Crediting Ledger: 200.00
2025-12-17 10:23:35,798 INFO sqlalchemy.engine.Engine UPDATE ledger_accounts SET balance=$1::NUMERIC(19, 4), updated_at=now() WHERE ledger_accounts.id = $2::UUID
2025-12-17 10:23:35,798 INFO sqlalchemy.engine.Engine [generated in 0.00035s] [(Decimal('200.0000'), UUID('66d4f290-bc62-4871-8e70-a7ecb5e47afb')), (Decimal('200.0000'), UUID('e0966039-9420-47ef-8f43-bdfdb2d432e6'))]
2025-12-17 10:23:35,803 INFO sqlalchemy.engine.Engine INSERT INTO ledger_entries (id, transaction_id, account_id, amount, entry_type, description, reference_type, reference_id, reversed, reversal_entry_id, created_by) VALUES ($1::UUID, $2::VARCHAR, $3::UUID, $4::NUMERIC(19, 4), $5::VARCHAR, $6::VARCHAR, ... 187 characters truncated ... 1::UUID, $22::UUID) RETURNING ledger_entries.created_at, ledger_entries.posted_at, ledger_entries.id
2025-12-17 10:23:35,804 INFO sqlalchemy.engine.Engine [generated in 0.00032s (insertmanyvalues) 1/1 (ordered)] (UUID('8a74e05c-d44e-4ec2-ba53-2de4468625cb'), 'manual_credit_406461ba-9ac2-424a-89d6-f18fd09272b5', UUID('e0966039-9420-47ef-8f43-bdfdb2d432e6'), Decimal('200.00'), 'DEBIT', 'Manual Credit for Test', 'MANUAL', UUID('883a4e2d-6635-49eb-8851-7dde7d50b173'), False, None, None, UUID('600789eb-b0e6-4af8-9d34-ec6b2b52607d'), 'manual_credit_406461ba-9ac2-424a-89d6-f18fd09272b5', UUID('66d4f290-bc62-4871-8e70-a7ecb5e47afb'), Decimal('200.00'), 'CREDIT', 'Manual Credit for Test', 'MANUAL', UUID('89bf9e01-a757-4c73-811f-bd0b0aee5ed5'), False, None, None)
2025-12-17 10:23:35,807 INFO sqlalchemy.engine.Engine COMMIT
2025-12-17 10:23:35,809 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-17 10:23:35,810 INFO sqlalchemy.engine.Engine SELECT ledger_accounts.id, ledger_accounts.code, ledger_accounts.name, ledger_accounts.description, ledger_accounts.type, ledger_accounts.classification, ledger_accounts.user_id, ledger_accounts.entity_id, ledger_accounts.entity_type, ledger_accounts.balance, ledger_accounts.is_active, ledger_accounts.created_at, ledger_accounts.updated_at 
FROM ledger_accounts 
WHERE ledger_accounts.code = $1::VARCHAR
2025-12-17 10:23:35,810 INFO sqlalchemy.engine.Engine [cached since 0.04137s ago] ('2100-ebf3fe71',)
2025-12-17 10:23:35,816 INFO sqlalchemy.engine.Engine SELECT sum(ledger_entries.amount) FILTER (WHERE ledger_entries.entry_type = $1::VARCHAR) AS credits, sum(ledger_entries.amount) FILTER (WHERE ledger_entries.entry_type = $2::VARCHAR) AS debits 
FROM ledger_entries 
WHERE ledger_entries.account_id = $3::UUID AND ledger_entries.reversed = false
2025-12-17 10:23:35,816 INFO sqlalchemy.engine.Engine [generated in 0.00031s] ('CREDIT', 'DEBIT', UUID('66d4f290-bc62-4871-8e70-a7ecb5e47afb'))
2025-12-17 10:23:35,822 INFO sqlalchemy.engine.Engine SELECT sum(rides.final_price * $1::NUMERIC(10, 2)) AS sum_1 
FROM rides 
WHERE rides.driver_id = $2::UUID AND rides.status = $3::VARCHAR AND rides.created_at > $4::TIMESTAMP WITH TIME ZONE
2025-12-17 10:23:35,822 INFO sqlalchemy.engine.Engine [generated in 0.00034s] (Decimal('0.80'), UUID('ebf3fe71-e606-4c9d-a760-a6c7affc40c6'), 'COMPLETED', datetime.datetime(2025, 12, 16, 13, 23, 35, 819324, tzinfo=datetime.timezone.utc))
2025-12-17 10:23:35,827 INFO sqlalchemy.engine.Engine SELECT sum(payouts.amount) AS sum_1 
FROM payouts 
WHERE payouts.driver_id = $1::UUID AND payouts.status IN ($2::VARCHAR, $3::VARCHAR)
2025-12-17 10:23:35,828 INFO sqlalchemy.engine.Engine [generated in 0.00045s] (UUID('ebf3fe71-e606-4c9d-a760-a6c7affc40c6'), 'PENDING', 'PROCESSING')
Initial Balance: {'total_balance': Decimal('200.0000'), 'hold_amount': Decimal('0'), 'pending_payouts': Decimal('0'), 'available_balance': Decimal('200.0000')}
Requesting Payout: 50.00
2025-12-17 10:23:35,833 INFO sqlalchemy.engine.Engine SELECT ledger_accounts.id, ledger_accounts.code, ledger_accounts.name, ledger_accounts.description, ledger_accounts.type, ledger_accounts.classification, ledger_accounts.user_id, ledger_accounts.entity_id, ledger_accounts.entity_type, ledger_accounts.balance, ledger_accounts.is_active, ledger_accounts.created_at, ledger_accounts.updated_at 
FROM ledger_accounts 
WHERE ledger_accounts.code = $1::VARCHAR
2025-12-17 10:23:35,833 INFO sqlalchemy.engine.Engine [cached since 0.06469s ago] ('2100-ebf3fe71',)
2025-12-17 10:23:35,836 INFO sqlalchemy.engine.Engine SELECT sum(ledger_entries.amount) FILTER (WHERE ledger_entries.entry_type = $1::VARCHAR) AS credits, sum(ledger_entries.amount) FILTER (WHERE ledger_entries.entry_type = $2::VARCHAR) AS debits 
FROM ledger_entries 
WHERE ledger_entries.account_id = $3::UUID AND ledger_entries.reversed = false
2025-12-17 10:23:35,836 INFO sqlalchemy.engine.Engine [cached since 0.02044s ago] ('CREDIT', 'DEBIT', UUID('66d4f290-bc62-4871-8e70-a7ecb5e47afb'))
2025-12-17 10:23:35,839 INFO sqlalchemy.engine.Engine SELECT sum(rides.final_price * $1::NUMERIC(10, 2)) AS sum_1 
FROM rides 
WHERE rides.driver_id = $2::UUID AND rides.status = $3::VARCHAR AND rides.created_at > $4::TIMESTAMP WITH TIME ZONE
2025-12-17 10:23:35,839 INFO sqlalchemy.engine.Engine [cached since 0.01737s ago] (Decimal('0.80'), UUID('ebf3fe71-e606-4c9d-a760-a6c7affc40c6'), 'COMPLETED', datetime.datetime(2025, 12, 16, 13, 23, 35, 838043, tzinfo=datetime.timezone.utc))
2025-12-17 10:23:35,842 INFO sqlalchemy.engine.Engine SELECT sum(payouts.amount) AS sum_1 
FROM payouts 
WHERE payouts.driver_id = $1::UUID AND payouts.status IN ($2::VARCHAR, $3::VARCHAR)
2025-12-17 10:23:35,843 INFO sqlalchemy.engine.Engine [cached since 0.01572s ago] (UUID('ebf3fe71-e606-4c9d-a760-a6c7affc40c6'), 'PENDING', 'PROCESSING')
2025-12-17 10:23:35,848 INFO sqlalchemy.engine.Engine INSERT INTO payouts (id, driver_id, amount, currency, status, payout_method, bank_details, provider, provider_transaction_id, failure_reason, processing_started_at, completed_at, failed_at) VALUES ($1::UUID, $2::UUID, $3::NUMERIC(19, 2), $4::VARCHAR, $5::VARCHAR, $6::VARCHAR, $7::JSONB, $8::VARCHAR, $9::VARCHAR, $10::VARCHAR, $11::TIMESTAMP WITH TIME ZONE, $12::TIMESTAMP WITH TIME ZONE, $13::TIMESTAMP WITH TIME ZONE) RETURNING payouts.created_at
2025-12-17 10:23:35,848 INFO sqlalchemy.engine.Engine [generated in 0.00060s] (UUID('c93ec8eb-8682-4817-950b-7e1bfa785276'), UUID('ebf3fe71-e606-4c9d-a760-a6c7affc40c6'), Decimal('50.00'), 'BRL', 'PENDING', 'pix', '{"pix_key": null}', 'efi', None, None, None, None, None)
2025-12-17 10:23:35,851 INFO sqlalchemy.engine.Engine COMMIT
2025-12-17 10:23:35,853 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-17 10:23:35,856 INFO sqlalchemy.engine.Engine SELECT payouts.id, payouts.driver_id, payouts.amount, payouts.currency, payouts.status, payouts.payout_method, payouts.bank_details, payouts.provider, payouts.provider_transaction_id, payouts.provider_response, payouts.failure_reason, payouts.created_at, payouts.processing_started_at, payouts.completed_at, payouts.failed_at 
FROM payouts 
WHERE payouts.id = $1::UUID
2025-12-17 10:23:35,856 INFO sqlalchemy.engine.Engine [generated in 0.00043s] (UUID('c93ec8eb-8682-4817-950b-7e1bfa785276'),)
2025-12-17 10:23:35,860 INFO sqlalchemy.engine.Engine SELECT ledger_accounts.id, ledger_accounts.code, ledger_accounts.name, ledger_accounts.description, ledger_accounts.type, ledger_accounts.classification, ledger_accounts.user_id, ledger_accounts.entity_id, ledger_accounts.entity_type, ledger_accounts.balance, ledger_accounts.is_active, ledger_accounts.created_at, ledger_accounts.updated_at 
FROM ledger_accounts 
WHERE ledger_accounts.code = $1::VARCHAR
2025-12-17 10:23:35,860 INFO sqlalchemy.engine.Engine [cached since 0.09143s ago] ('2100-ebf3fe71',)
2025-12-17 10:23:35,863 INFO sqlalchemy.engine.Engine SELECT ledger_accounts.id, ledger_accounts.code, ledger_accounts.name, ledger_accounts.description, ledger_accounts.type, ledger_accounts.classification, ledger_accounts.user_id, ledger_accounts.entity_id, ledger_accounts.entity_type, ledger_accounts.balance, ledger_accounts.is_active, ledger_accounts.created_at, ledger_accounts.updated_at 
FROM ledger_accounts 
WHERE ledger_accounts.code = $1::VARCHAR
2025-12-17 10:23:35,863 INFO sqlalchemy.engine.Engine [cached since 0.09485s ago] ('1200',)
2025-12-17 10:23:35,867 INFO sqlalchemy.engine.Engine UPDATE ledger_accounts SET balance=$1::NUMERIC(19, 4), updated_at=now() WHERE ledger_accounts.id = $2::UUID
2025-12-17 10:23:35,867 INFO sqlalchemy.engine.Engine [cached since 0.06958s ago] [(Decimal('150.0000'), UUID('66d4f290-bc62-4871-8e70-a7ecb5e47afb')), (Decimal('-100.0000'), UUID('d803d692-4bb3-4f5c-a997-e8489cdb57fe'))]
2025-12-17 10:23:35,870 INFO sqlalchemy.engine.Engine INSERT INTO ledger_entries (id, transaction_id, account_id, amount, entry_type, description, reference_type, reference_id, reversed, reversal_entry_id, created_by) VALUES ($1::UUID, $2::VARCHAR, $3::UUID, $4::NUMERIC(19, 4), $5::VARCHAR, $6::VARCHAR, ... 187 characters truncated ... 1::UUID, $22::UUID) RETURNING ledger_entries.created_at, ledger_entries.posted_at, ledger_entries.id
2025-12-17 10:23:35,870 INFO sqlalchemy.engine.Engine [cached since 0.06718s ago (insertmanyvalues) 1/1 (ordered)] (UUID('f4a5a967-dd8d-455a-a4b6-96e5e8a0bc8e'), 'payout_c93ec8eb-8682-4817-950b-7e1bfa785276', UUID('66d4f290-bc62-4871-8e70-a7ecb5e47afb'), Decimal('50.00'), 'DEBIT', 'Payout Request c93ec8eb-8682-4817-950b-7e1bfa785276', 'PAYOUT', UUID('c93ec8eb-8682-4817-950b-7e1bfa785276'), False, None, None, UUID('9c304130-4f7c-45de-97a8-d715b4bd2b83'), 'payout_c93ec8eb-8682-4817-950b-7e1bfa785276', UUID('d803d692-4bb3-4f5c-a997-e8489cdb57fe'), Decimal('50.00'), 'CREDIT', 'Payout Reservation c93ec8eb-8682-4817-950b-7e1bfa785276', 'PAYOUT', UUID('c93ec8eb-8682-4817-950b-7e1bfa785276'), False, None, None)
2025-12-17 10:23:35,874 INFO sqlalchemy.engine.Engine COMMIT
Payout Created: c93ec8eb-8682-4817-950b-7e1bfa785276 - Status: PENDING
2025-12-17 10:23:35,877 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-17 10:23:35,878 INFO sqlalchemy.engine.Engine SELECT ledger_accounts.id, ledger_accounts.code, ledger_accounts.name, ledger_accounts.description, ledger_accounts.type, ledger_accounts.classification, ledger_accounts.user_id, ledger_accounts.entity_id, ledger_accounts.entity_type, ledger_accounts.balance, ledger_accounts.is_active, ledger_accounts.created_at, ledger_accounts.updated_at 
FROM ledger_accounts 
WHERE ledger_accounts.code = $1::VARCHAR
2025-12-17 10:23:35,878 INFO sqlalchemy.engine.Engine [cached since 0.1095s ago] ('2100-ebf3fe71',)
2025-12-17 10:23:35,882 INFO sqlalchemy.engine.Engine SELECT sum(ledger_entries.amount) FILTER (WHERE ledger_entries.entry_type = $1::VARCHAR) AS credits, sum(ledger_entries.amount) FILTER (WHERE ledger_entries.entry_type = $2::VARCHAR) AS debits 
FROM ledger_entries 
WHERE ledger_entries.account_id = $3::UUID AND ledger_entries.reversed = false
2025-12-17 10:23:35,882 INFO sqlalchemy.engine.Engine [cached since 0.06632s ago] ('CREDIT', 'DEBIT', UUID('66d4f290-bc62-4871-8e70-a7ecb5e47afb'))
2025-12-17 10:23:35,886 INFO sqlalchemy.engine.Engine SELECT sum(rides.final_price * $1::NUMERIC(10, 2)) AS sum_1 
FROM rides 
WHERE rides.driver_id = $2::UUID AND rides.status = $3::VARCHAR AND rides.created_at > $4::TIMESTAMP WITH TIME ZONE
2025-12-17 10:23:35,886 INFO sqlalchemy.engine.Engine [cached since 0.06472s ago] (Decimal('0.80'), UUID('ebf3fe71-e606-4c9d-a760-a6c7affc40c6'), 'COMPLETED', datetime.datetime(2025, 12, 16, 13, 23, 35, 884734, tzinfo=datetime.timezone.utc))
2025-12-17 10:23:35,891 INFO sqlalchemy.engine.Engine SELECT sum(payouts.amount) AS sum_1 
FROM payouts 
WHERE payouts.driver_id = $1::UUID AND payouts.status IN ($2::VARCHAR, $3::VARCHAR)
2025-12-17 10:23:35,891 INFO sqlalchemy.engine.Engine [cached since 0.0637s ago] (UUID('ebf3fe71-e606-4c9d-a760-a6c7affc40c6'), 'PENDING', 'PROCESSING')
Post-Payout Balance: {'total_balance': Decimal('150.0000'), 'hold_amount': Decimal('0'), 'pending_payouts': Decimal('50.00'), 'available_balance': Decimal('150.0000')}
--- Payout Flow Verified Successfully ---
2025-12-17 10:23:35,893 INFO sqlalchemy.engine.Engine ROLLBACK
